<html xmlns:th="http://www.thymeleaf.org" th:replace="starter">
<meta charset="utf-8" />
<div class="row" th:fragment="contenido">

	<!-- ## SECCION DE PROUDCTOS  -->

	<div class="col-md-6">
		<div class="box box-default">
			<div class="box-header with-border">
				<h3 class="box-title">Productos</h3>

				<div class="box-tools pull-right">
					<button type="button" class="btn btn-box-tool"
						data-widget="collapse">
						<i class="fa fa-minus"></i>
					</button>
					<button type="button" class="btn btn-box-tool" data-widget="remove">
						<i class="fa fa-remove"></i>
					</button>
				</div>
			</div>
			<!-- /.box-header -->
			<div class="box-body">
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label>Busqueda</label>
							<div class="box-body">
								<div id="magicsuggest"></div>
							</div>
							<!-- /.box-body -->
						</div>
						<!-- /.form-group -->
						<div class="form-group">
							<label for="inputNombre">Código:</label> 
							<input name="codigo" type="text" class="form-control" id="codigo"
							data-validation="required">
							<input name="id" type="hidden" id="id">
						</div>
						<div class="form-group">
							<label for="inputNombre">Nombre:</label> 
							<input type="text" class="form-control" id="nombre" name="nombre"
							placeholder="Ingrese Nombre"
							data-validation="required"
			 				data-validation-error-msg-required="Debe ingresar el nombre del cliente">	
						</div>
					</div>
					<!-- /.col -->
					<div class="col-md-6">
						<div class="form-group">
							<label>Precio Venta:</label>
							<div class="input-group">
								<div class="input-group-addon">
									<i class="fa fa-usd"></i>
								</div>
								<input type="text" class="form-control" id="precioVenta" name="precioVenta"
							placeholder="Ingrese Precio de Venta"
							data-validation="required"
			 				data-validation-error-msg-required="Debe ingresar el precio de venta">

							</div>
							<!-- /.input group -->
						</div>
					</div>

					<div class="col-md-6">
						<div class="form-group">
							<label>Stock Actual:</label>

							<div class="input-group">
								<div class="input-group-addon">
									<i class="fa fa-hashtag"></i>
								</div>
								<input type="text" class="form-control" id="stockActual" name="stockActual">
							</div>
							<!-- /.input group -->
						</div>
					</div>

					<div class="col-md-6">
						<div class="form-group">
							<label>Cantidad:</label>
							<div class="input-group">
								<div class="input-group-addon">
									<i class="fa fa-usd"></i>
								</div>
								<input type="text" class="form-control" id="cantidad" name="cantidad"
							placeholder="Ingrese cantidad"
							data-validation="required"
			 				data-validation-error-msg-required="Debe ingresar la cantidad">
							</div>
							<!-- /.input group -->
						</div>
					</div>
					<!-- /.col -->
				</div>
				<!-- /.row -->
			</div>
			<div class="alert alert-danger col-md-10 col-md-offset-1 hidden" id="errorDiv">
			  <strong id="msgError"></strong>
			</div>
			<!-- /.box-body -->
			<div class="modal-footer">
				<button type="button" class="btn btn-success" onclick="agregarDetalle()">
					<span class="glyphicon glyphicon-shopping-cart"></span> Agregar
					Producto
				</button>
			</div>
		</div>
	</div>

	<!-- #### SECCION DE VENTA -->


	<div class="col-md-6">
		<div class="box box-default">
			<div class="box-header with-border">
				<h3 class="box-title">Venta</h3>

				<div class="box-tools pull-right">
					<button type="button" class="btn btn-box-tool"
						data-widget="collapse">
						<i class="fa fa-minus"></i>
					</button>
					<button type="button" class="btn btn-box-tool" data-widget="remove">
						<i class="fa fa-remove"></i>
					</button>
				</div>
			</div>
			<!-- /.box-header -->
			<div class="box-body">
				<div class="row">
					<div class="col-md-12">
				    <form th:action="@{/venta/confirmar}" th:object="${ventaCabecera}" method="post" role="form" id="form-cabecera">
						<!-- total a pagar  -->
						<div class="col-md-12">
							<div class="form-group">
								<label>Cliente:</label>
								<div class="box-body">
									<div id="magicsuggestCliente"></div>
									<input type="hidden" th:field="*{cliente}">
								</div>
								<!-- /.box-body -->
							</div>
						<div class="col-md-6">
							<div class="form-group">
								<label>Sub-Total:</label>

								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-usd"></i>
									</div>
									<input type="text" class="form-control"  id="subTotal" name="subTotal"
							placeholder="Ingrese sub-total"
							data-validation="required"
			 				data-validation-error-msg-required="Debe ingresar monto sin iva">
								</div>
								<!-- /.input group -->
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="exampleInputFile">Fecha:</label>
								<div class="input-group date" >
									
								    <input id="fechaEmision"  name="fechaEmision"  type="text" class="form-control datepicker1"
								    data-validation="required"
		 			  				data-validation-error-msg-required="Ingrese fecha en la cual se realizo la venta">
								    <div class="input-group-addon">
								        <span class="glyphicon glyphicon-th"></span>
								    </div>
								</div>
							</div>
						</div>
						
						<label>Total:</label>
						<div class="col-md-12">
							<div class="form-group">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-usd"></i>
									</div>
									<input type="text" class="form-control input-money" value="0.0" name="montoTotal" id="montoTotal">
								</div>
								<!-- /.input group -->
							</div>
						</div>
					</div>
					<div class="alert alert-danger col-md-10 col-md-offset-1 hidden" id="errorDivC">
					  <strong id="msgErrorC"></strong>
					</div>
						<div class="modal-footer" style="border: none;">
							<button type="button" class="btn btn-primary" id="confirmarVenta" disabled >
								<span class="glyphicon glyphicon-ok"></span> Confirmar
							</button>
						</div>
						</form>
					</div>
				</div>
				<!-- /.row -->
			</div>
			<!-- /.box-body -->
			
		</div>
	</div>
	
        <div class="col-xs-12">
          <div class="box">
            <div class="box-header">
              <h3 class="box-title">Productos Agregados</h3>
            </div>
            <!-- /.box-header -->
            <div class="box-body table-responsive no-padding" id="tableDetail">
            	<div id="idTableDetail">
	              <table class="table table-hover" id="tabla-detalle">
	                <tbody><tr>
	                  <th>Código</th>
	                  <th>Nombre</th>
	                  <th>Cant.</th>
	                  <th>Precio Unit.</th>
	                  <th>Precio Total</th>
	                  <th>Acción</th>
	                </tr>
	                <tr id="sin">
	                  <td colspan="6">sin datos..</td>
	                </tr>
	              </tbody></table>
              </div>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
<!-- Modal de confirmación de venta	 -->
	<div class="modal fade" id="modal-default">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">Esta Seguro?</h4>
            </div>
            <form th:action="@{/venta/comprobante}" method="post" role="form" id="form-comprobante">
            <input type="hidden" name="comprobanteVenta" id="comprobanteVenta">
            <div class="modal-body">
              <p><b>Venta Realizada con Éxito!!</b></p>
              <input type="hidden" th:value="${ventaCabeceraId}" name="id_venta_cabecera">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Realizar Otra Venta</button>
              <button type="submit" class="btn btn-primary" name="accion" value="comprobante">Imprimir Comprobante</button>
            </div>
            </form>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

	<script th:inline="javascript">
					/*<![CDATA[*/
		$(document).ready(
				function() {

					var idVenta = '[[${ventaCabeceraId}]]';
					$("#id_venta_cabecera").val(idVenta);
					if(/*[[${msgExitoVenta}]]*/){
						$("#modal-default").modal('show');
					}
					
					$("#confirmarVenta").on("click",function(){
						confirmarVenta();
					})
					suggestProducto = crearMagicSuggest('magicsuggest',
							[[@{/producto/suggest}]], 'id', 'descripcion');
					suggestCliente = crearMagicSuggest('magicsuggestCliente',
							[[@{/cliente/suggest}]], 'id', 'nombre');
					
					$(suggestCliente).on('selectionchange', function(a,b,c){
						var cliente = c[0];
						$("#cliente").val(cliente.id);
					});
					var fechaInicio = new Date();
					var fecha=new Date();
					var year = fecha.getFullYear();
					var mes = fecha.getMonth()
					var dia = fecha.getDate();
					$('.datepicker1').datepicker({endDate:fechaInicio, language:'es', format: 'dd/mm/yyyy'});
					$('.datepicker1').datepicker('update', new Date(year, mes, dia));
					//buscar producto
					$(suggestProducto).on('selectionchange', function(a,b,c){
						if (c.length == 0){
							$("#codigo").val("");
							$("#nombre").val("");
							$("#precioVenta").val("");
							$("#cantidad").val("");
							$("#stockActual").val("");
							$("#id").val("");
						}else{
							var producto = c[0];
							$("#codigo").val(producto.codigo);
							$("#nombre").val(producto.descripcion);
// 							$("#precioVenta").val(formatMontoDecimal(producto.precioVenta.toString()));
							$("#precioVenta").val(producto.precioVenta);
							$("#cantidad").val(1);
							$("#stockActual").val(producto.cantidad);
							$("#id").val(producto.id);
						}
						
						  console.log("cambió el valor del maicsuggest: " + this.getValue());
						});
					1
					var fecha = new Date();
					var dd = fecha.getDate();
					var mm = (fecha.getMonth() +1);
					dd=addZero(dd);
					mm=addZero(mm);
					fechaActual = fecha.getFullYear()+"-"+mm+"-"+dd;
					$("#fechaVenta").val(fechaActual);
					
					function addZero(i) {
					    if (i < 10) {
					        i = '0' + i;
					    }
					    return i;
					}
					
				});
		
		
		function agregarDetalle(){
			var idProducto = $("#id").val();
			var cantidad = $("#cantidad").val();
			
			if(idProducto == "" || cantidad=="" ){
				$("#msgError").html("Debe seleccionar un producto!!");
				$("#errorDiv").removeClass("hidden");
			}else{
				$("#errorDiv").addClass("hidden");
				$("#confirmarVenta").removeAttr("disabled");
			}
			
			$.ajax({
		        type: "POST",
		        url: "/gestionart/venta/agregar-detalle",
		        data: { 
		        	id_producto: idProducto,
		        	cantidad: cantidad
		        }
		    }).done(function(data){
		    	$('#sin').remove();
		    	//agregamos una fila mas al table de detalle
		    	$('#tableDetail').html('');
		    	$('#tableDetail').html(data);
		    	//limpiamos todos los campos
		    	suggestProducto.clear();
		    	$("#codigo").val("");
				$("#nombre").val("");
				$("#precioVenta").val("");
				$("#cantidad").val("");
				$("#stockActual").val("");
				$("#id").val("");
		    	
		    	$("#textError").html("Producto agregado corretamente al detalle");
		    	$('html, body').animate({scrollTop: 0}, 800);
		    	$("#alerta").fadeIn(2000);
				$("#alerta").fadeOut(2000);
		        
		    }).fail(function (request, status, error) {
		        var errorData = request.responseJSON;
		        ajaxErrorHandler(errorData, status, request.status, "alert-error","msgTitleError","msgDescripcionError");
		    });
		}
		
		function removerDetalle(idProducto){
			$("#confirmarVenta").attr("disabled", "true");
			$.ajax({
		        type: "POST",
		        url: "/gestionart/venta/eliminar-detalle",
		        data: { 
		        	id_producto: idProducto
		        }
		    }).done(function(data){
		    	//eliminamos una fila mas al table de detalle
		    	$('#tableDetail').html('');
		    	$('#tableDetail').html(data);
		    	$("#textError").html("Producto eliminado corretamente al detalle");
		    	$("#alerta").fadeIn(2000);
				$("#alerta").fadeOut(2000);
// 		    	$('#tableDetail').html(data);
		        
		    }).fail(function (request, status, error) {
	   	        var errorData = request.responseJSON;
		    });
		}
		
		function confirmarVenta(){
			var idCliente = $("#cliente").val();
			
			if(idCliente==""){
				$("#msgErrorC").html("Debe seleccionar un cliente!!");
				$("#errorDivC").removeClass("hidden");
			}else{
				$("#errorDivC").addClass("hidden");
				$("#form-cabecera").submit();
			}
		}
	</script>
</div>
</html>